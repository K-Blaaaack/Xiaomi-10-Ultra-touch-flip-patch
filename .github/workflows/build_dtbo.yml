name: Build DTBO Patches

on:
  push:
    paths:
      - 'dtbo/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - run: sudo apt install -y device-tree-compiler python3
    - run: chmod +x scripts/build_dtbo.sh scripts/mkdtboimg.py
    - run: |
        if [ -f dtbo/miui_touch_invert_overlay.dts ]; then
          scripts/build_dtbo.sh dtbo/miui_touch_invert_overlay.dts dtbo_fixed_miui.img
        fi
        if [ -f dtbo/aosp_touch_invert_overlay.dts ]; then
          scripts/build_dtbo.sh dtbo/aosp_touch_invert_overlay.dts dtbo_fixed_aosp.img
        fi
        ls -la dtbo_fixed_*.img 2>/dev/null || echo "No DTBO files generated"
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dtbo-patches-${{ github.run_number }}
        path: dtbo_fixed_*.img
        retention-days: 30