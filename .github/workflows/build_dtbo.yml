# .github/workflows/build_dtbo.yml
name: Build DTBO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-dtbo:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout 仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y device-tree-compiler python3

      # 3. 创建输出目录
      - name: Prepare directories
        run: |
          mkdir -p scripts/dtb_tmp
          mkdir -p out

      # 4. 编译 DTS -> DTB
      - name: Compile DTS to DTB
        run: |
          for dts in dtbo/*.dts; do
            dtb="scripts/dtb_tmp/$(basename "${dts%.dts}.dtb")"
            echo "Compiling $dts -> $dtb"
            dtc -I dts -O dtb -o "$dtb" "$dts"
          done

      # 5. 打包 DTB -> DTBO
      - name: Generate DTBO
        run: |
          DTB_FILES=$(find scripts/dtb_tmp -type f -name "*.dtb" | sort)
          if [ -z "$DTB_FILES" ]; then
            echo "No DTB files found!"
            exit 1
          fi
          python3 mkdtboimg.py create out/dtbo.img --page_size 4096 $DTB_FILES

      # 6. 上传产物
      - name: Upload DTBO
        uses: actions/upload-artifact@v3
        with:
          name: dtbo
          path: out/dtbo.img
