name: Build DTBO

on:
  push:
    paths:
      - 'dtbo/**'
      - 'scripts/**'
  pull_request:
    paths:
      - 'dtbo/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  build-dtbo:
    name: Build MIUI & AOSP DTBO
    runs-on: ubuntu-latest

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y device-tree-compiler python3 python3-pip
        pip3 install --upgrade pip

    # 3. éªŒè¯ mkdtboimg.py
    - name: Verify mkdtboimg.py
      run: |
        if [ ! -f "scripts/mkdtboimg.py" ]; then
          echo "âŒ Error: scripts/mkdtboimg.py not found!"
          exit 1
        fi
        echo "âœ… mkdtboimg.py found"
        python3 scripts/mkdtboimg.py --help

    # 4. å‡†å¤‡æ„å»ºè„šæœ¬
    - name: Prepare build scripts
      run: |
        chmod +x scripts/build_dtbo.sh
        echo "âœ… Build scripts ready"

    # 5. æ„å»º MIUI DTBO
    - name: Build MIUI DTBO
      id: miui
      run: |
        if [ -f "dtbo/miui_touch_invert_overlay.dts" ]; then
          echo "ğŸ”¨ Building MIUI DTBO..."
          scripts/build_dtbo.sh dtbo/miui_touch_invert_overlay.dts dtbo_fixed_miui.img
          
          SIZE=$(wc -c < dtbo_fixed_miui.img)
          echo "âœ… MIUI DTBO: ${SIZE} bytes"
          echo "miui_size=${SIZE}" >> $GITHUB_OUTPUT
          echo "miui_success=true" >> $GITHUB_OUTPUT
          
          # éªŒè¯æ–‡ä»¶
          file dtbo_fixed_miui.img
        else
          echo "âš ï¸  MIUI DTS file not found, skipping"
          echo "miui_size=0" >> $GITHUB_OUTPUT
          echo "miui_success=false" >> $GITHUB_OUTPUT
        fi

    # 6. æ„å»º AOSP DTBO
    - name: Build AOSP DTBO
      id: aosp
      run: |
        if [ -f "dtbo/aosp_touch_invert_overlay.dts" ]; then
          echo "ğŸ”¨ Building AOSP DTBO..."
          scripts/build_dtbo.sh dtbo/aosp_touch_invert_overlay.dts dtbo_fixed_aosp.img
          
          SIZE=$(wc -c < dtbo_fixed_aosp.img)
          echo "âœ… AOSP DTBO: ${SIZE} bytes"
          echo "aosp_size=${SIZE}" >> $GITHUB_OUTPUT
          echo "aosp_success=true" >> $GITHUB_OUTPUT
          
          # éªŒè¯æ–‡ä»¶
          file dtbo_fixed_aosp.img
        else
          echo "âš ï¸  AOSP DTS file not found, skipping"
          echo "aosp_size=0" >> $GITHUB_OUTPUT
          echo "aosp_success=false" >> $GITHUB_OUTPUT
        fi

    # 7. æ„å»ºæ‘˜è¦
    - name: Build Summary
      run: |
        echo "## ğŸ¯ DTBO Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Patch Type | Status | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.miui.outputs.miui_success }}" = "true" ]; then
          echo "| **MIUI** | âœ… Success | ${{ steps.miui.outputs.miui_size }} bytes |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| **MIUI** | âš ï¸  Skipped | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.aosp.outputs.aosp_success }}" = "true" ]; then
          echo "| **AOSP** | âœ… Success | ${{ steps.aosp.outputs.aosp_size }} bytes |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| **AOSP** | âš ï¸  Skipped | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ğŸ“¦ Artifacts**: Available below" >> $GITHUB_STEP_SUMMARY

    # 8. ä¸Šä¼ äº§ç‰©ï¼ˆä»…å½“è‡³å°‘ä¸€ä¸ªæˆåŠŸæ—¶ï¼‰
    - name: Upload DTBO Artifacts
      if: steps.miui.outputs.miui_success == 'true' || steps.aosp.outputs.aosp_success == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: dtbo-patches-${{ github.sha }}
        path: |
          dtbo_fixed_miui.img
          dtbo_fixed_aosp.img
        retention-days: 30

    # 9. PR è‡ªåŠ¨æ³¨é‡Š
    - name: Comment PR
      if: github.event_name == 'pull_request' && (steps.miui.outputs.miui_success == 'true' || steps.aosp.outputs.aosp_success == 'true')
      uses: actions/github-script@v7
      with:
        script: |
          const core = require('@actions/core');
          const miui = '${{ steps.miui.outputs.miui_success }}';
          const aosp = '${{ steps.aosp.outputs.aosp_success }}';
          
          let table = '| Patch | Size | Status |\n|-------|------|--------|\n';
          
          if (miui === 'true') {
            table += `| **MIUI** | ${{ steps.miui.outputs.miui_size }}B | âœ… |\n`;
          } else {
            table += '| **MIUI** | - | âš ï¸ |\n';
          }
          
          if (aosp === 'true') {
            table += `| **AOSP** | ${{ steps.aosp.outputs.aosp_size }}B | âœ… |\n`;
          } else {
            table += '| **AOSP** | - | âš ï¸ |\n';
          }
          
          const body = `## ğŸ¯ DTBO Patches Ready!

${table}

**ğŸ“¥ Download**: [Artifacts](#artifacts)

**ğŸ’¡ Usage**:
\`\`\`bash
# MIUI è®¾å¤‡
fastboot flash dtbo dtbo_fixed_miui.img

# AOSP è®¾å¤‡  
fastboot flash dtbo dtbo_fixed_aosp.img
\`\`\``;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });